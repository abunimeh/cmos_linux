{% extends "base.html" %}
{% load i18n %}
{% load staticfiles %}

{% block title %}
Regression Info
{% endblock %}

{% block content %}
<div id="container_st" class="clearfix" style="width: 1300px;">
  <div class="content" style="height:auto; width: 1280px; margin: 0px auto;">
    <fieldset id="items_list">
      <p>
        <span>Teams:</span> 
        <select id="team" class="team" data-value="infra" data-first-title="Choose" disabled="disabled">
        </select>
        <span>Users:</span> 
        <select id="user" class="user" data-value="jenkins" data-first-title="Choose" disabled="disabled"></select>
        <span>Projects:</span>
        <select id="project" class="project" data-value="Choose Projects" data-first-title="Choose" disabled="disabled"></select>
        <span>Modules:</span>
        <select id="module" class="module" data-value="Choose Modules" data-first-title="Choose" disabled="disabled"></select>
        <span>Start:</span>
        <input class="datainp" id="indate" type="text" placeholder="Choose" readonly> 
        <span>End:</span>
        <input class="datainp" id="dateinfo" type="text" placeholder="Choose"  readonly>
        <input  class="tsearch" type="button" name="search" value="Search">
      </p>
    </fieldset>
    <hr style="clear: both;height: 2px; width: 1280px; background: rgba(33, 7, 7, 0.19) none repeat scroll 0% 0%;">
    <div id="show_all">
      <div id="show_tab1">  
        <table id="tab1" class="display">
          <thead>
            <tr>
              <th>User</th>
              <th>Email</th>
            </tr>
          </thead>
          <tfoot>
            <tr>
              <th></th>
              <th></th>
            </tr>
          </tfoot>
          <tbody>
            {% for user in user_list %}
            <tr align="center">
              <td>{{ user }}</a></td>
              <td>{{ user }}@cpu.com.cn</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>  
      </div>
    </div>
  </div>
</div>
{% endblock %}


{% block js %}
<script type="text/javascript">
  $(function() {
    $.cxSelect.defaults.url = "{% url 'regr:query_select' %}";    
    $("#items_list").cxSelect({
      selects : ["team", "user", "project", "module"],
      nodata : "none"
    });

    jeDate.skin('gray');
    jeDate({
      dateCell:"#indate",//isinitVal:true,
      format:"YYYY-MM-DD",
      isinitVal:true,
      date_diff: 1,
      isTime:true, //isClear:false,
      minDate:"2014-01-01 00:00:00",
    })

    jeDate({
      dateCell:"#dateinfo",
      format:"YYYY-MM-DD",
      isinitVal:true,
      isTime:true, //isClear:false,
      minDate:"2014-01-01 00:00:00",
    })

    $('#tab1').DataTable({
      "scrollY": "350px",
      "deferRender": true,
      "order":[[0,"asc"]],
      "lengthChange": false,
      "bPaginate": true, //翻页功能
      "searching": false,
    });
    $(".tsearch").click(function(){
      user = document.getElementById("user").value;
      proj = document.getElementById("project").value;
      module = document.getElementById("module").value;
      tstart = document.getElementById("indate").value;
      tend = document.getElementById("dateinfo").value;
      if (tstart == "") {
        alert("Please Choose running start time!");
      }
      else if (tend == "") {
        alert("Please Choose running end time!");        
      }
      else {
        if (user == "") {
          alert("Please Choose User!")
        }
        else {
          if (proj == "") {  
            $('#show_all').empty();
            $('#show_all').append('<div><input class="csearch" type="button"  value="show Line" /><input  class="psearch" type="button"  value="show Pie" /><input  class="close" type="button"  value="Close" /></div><div id="show_tab1"style="margin-top:20px;"><div><table id="tab1" class="display"><thead><tr><th>Project</th><th>Project Leader</th><th>Project Design Leader</th><th>Project Verif Leader</th><th>Passing Rate</th><th>Run Time</th></tr></thead><tfoot><tr><th></th><th></th><th></th><th></th><th></th><th></th></tr></tfoot><tbody></tbody></table></div><div id ="line_ct" style="display:none;margin:16px 0px;"><div id="ccontainer" style="min-width: 310px; height: 400px; margin: 0 auto;"></div></div><div id= "pcontainer" style="display: none;margin:16px 40px; height:410px;"><div id="left_ct" style="width:600px;float:left;" ><div id="lpcontainer" style="min-width: 310px; max-width: 600px; height: 400px; margin:0px;"></div></div><div id="right_ct" style="width:600px;float:left;"><div id="rpcontainer" style="min-width: 310px; max-width: 600px; height: 400px; margin:0px;"></div></div></div><div id="show_tab2" style="margin-top:20px;"><table id="tab2" class="display"><thead><tr><th>Project</th><th>Project Leader</th><th>Project Design Leader</th><th>Project Verif Leader</th><th>Passing Rate</th><th>Run Time</th></tr></thead><tfoot><tr><th></th><th></th><th></th><th></th><th></th><th></th></tr></tfoot><tbody></tbody></table></div></div>');
            $('#tab1').DataTable({      
                "deferRender": true,
                "destroy": true,
                "lengthChange": false,
                "lengthMenu": [
                    [5, 6, 8, -1],
                    [5, 10, 15, "All"]
                 ],//每页显示条数设置
                "bPaginate": true, //翻页功能
                "searching": true,
                "order":[[5,'desc']],
                "scrollY": "170px",//dt高度
                "ajax": {
                  url:"{% url 'regr:get_model' %}",
                  data: {'model':'proj','user':user, 'proj':'None', 'module':'None', 'tstart':tstart,'tend':tend, 'tflag':'day'},
                },  
                "columns": [
                  { "data": "day.model_list.0" },
                  { "data": "day.model_list.1" },
                  { "data": "day.model_list.2" },
                  { "data": "day.model_list.3" },
                  { "data": "day.items",
                    "render": function (data, type, full, meta) {
                      return data.pr + '%'+ "("+ data.pn + '/'+ data.tn +")"
                    },
                    "createdCell": function (tr, cellData, rowData, row, col) {
                      $(tr).css('background', cellData.bc);
                    }
                  },
                  { "data": "day.time",
                     "render": function (data, type, full, meta) {
                      return data.runt ;
                    }
                  }
                ],
                initComplete: function () {//列筛选
                   var api = this.api();
                   window.rt_dic = {};
                   window.ps_dic = {};
                   api.columns().indexes().flatten().each(function (i) {
                      if (i == 4) {
                           var column = api.column(i);
                           column.data().sort().each(function (d, j) {
                              ps_dic[j] = d;
                           });
                       } 
                       else if(i == 5) {
                           var column = api.column(i);
                           column.data().unique().sort().each(function (d, j) {
                              rt_dic[j] = d;
                           });
                       }   
                  });

                  api.columns().indexes().flatten().each(function (i) {
                       if (i !=4 && i!=5 ) {
                           var column = api.column(i);
                           var $span = $('<span class="addselect" style="font-size:11px;">▾</span>').appendTo($(column.header()))
                           var select = $('<select><option value="">All</option></select>')
                                   .appendTo($(column.header()))
                                   .on('click', function (evt) {
                                       evt.stopPropagation();
                                       var val = $.fn.dataTable.util.escapeRegex(
                                               $(this).val()
                                       );
                                       column.search(val ? '^' + val + '$' : '', true, false).draw();
                                   });
                           column.data().unique().sort().each(function (d, j) {
                               function delHtmlTag(str) {
                                   return str.replace(/<[^>]+>/g, "");//去掉html标签
                               }
 
                               d = delHtmlTag(d)
                               select.append('<option value="' + d + '">' + d + '</option>')
                               $span.append(select)
                           });
                       }
                   });
               },
            });
            $('#tab2').DataTable({      
              "deferRender": true,
              "destroy": true,
              "lengthChange": false,
                "bPaginate": true, //翻页功能
                "searching": true,
                "order":[[5,"desc"]],
                "scrollY": "350px",//dt高度
                "ajax": {
                  url:"{% url 'regr:get_model'%}",
                  data: {'model':'proj','user':user, 'proj':'None', 'module':'None', 'tstart':tstart, 'tend':tend, 'tflag':'sec'} 
                },   
                "columns": [
                { "data": "sec.model_list.0" },
                { "data": "sec.model_list.1" },
                { "data": "sec.model_list.2" },
                { "data": "sec.model_list.3" },
                { "data": "sec.items",
                  "render": function (data, type, full, meta) {
                    return data.pr + '%'+ "("+ data.pn + '/'+ data.tn +")" ;
                  },
                 "createdCell": function (tr, cellData, rowData, row, col) {
                    $(tr).css('background', cellData.bc);
                  } 
                },
                { "data": "sec.time",
                  "render": function (data, type, full, meta) {            
                    return data.runt;
                  } 
                }
                ],
                initComplete: function () {//列筛选
                  var api = this.api();
                  api.columns().indexes().flatten().each(function (i) {
                       if (i != 4 && i !=5) {
                           var column = api.column(i);
                           var $span = $('<span class="addselect" style="font-size:11px;">▾</span>').appendTo($(column.header()))
                           var select = $('<select><option value="">All</option></select>')
                                   .appendTo($(column.header()))
                                   .on('click', function (evt) {
                                       evt.stopPropagation();
                                       var val = $.fn.dataTable.util.escapeRegex(
                                               $(this).val()
                                       );
                                       column.search(val ? '^' + val + '$' : '', true, false).draw();
                                   });
                           column.data().unique().sort().each(function (d, j) {
                               function delHtmlTag(str) {
                                   return str.replace(/<[^>]+>/g, "");//去掉html标签
                               }
 
                               d = delHtmlTag(d)
                               select.append('<option value="' + d + '">' + d + '</option>')
                               $span.append(select)
                           });
                       }
                   });
                },
              });

              $(".csearch").click(function(){
                  $('#pcontainer').css("display","none");
                  $('#line_ct').css("display","block");
                  var dic_rt   = new Object();
                  var dic_proj = new Object();
                  var passrt   = new Array();
                  var fig_list = new Array();
                  function sortDict(dict) {
                    var dict2 = {}, keys = Object.keys(dict).sort();
                    for (var i=0, key, n=keys.length; i < n; ++i) {
                        key=keys[i];
                        dict2[key] = dict[key];
                    }
                    return dict2;
                  }
                  for (var key1 in rt_dic) {
                     for (var key2 in ps_dic) {
                        if (key1 == key2) {
                           if (rt_dic[key1].runt in dic_rt) {
                              dic_rt[rt_dic[key1].runt].push([ps_dic[key2].pr,rt_dic[key1].model]);
                           }
                           else {
                              dic_rt[rt_dic[key1].runt] = [[ps_dic[key2].pr,rt_dic[key1].model]];                          
                           }
                        }
                      }
                  }
                  var rtDic = sortDict(dic_rt);
                  for (var key in rtDic) {
                      var regEx = new RegExp("\\_", "gi");
                      var keys = key.replace(regEx,"/");
                      var sec  = Date.parse(keys)+24*60*60*1000;
                      for (var key1 in rtDic[key]) {
                        if(rtDic[key][key1][1] in dic_proj){
                          dic_proj[rtDic[key][key1][1]].push([sec,rtDic[key][key1][0]]);   
                        }
                        else {
                          dic_proj[rtDic[key][key1][1]]=[[sec,rtDic[key][key1][0]]];
                        }
                      }
                  }
                  for (var key in dic_proj) {
                      fig_list.push({'name':key, 'data': dic_proj[key]});
                  }

                  Highcharts.chart('ccontainer', {
                      chart: {
                          type: 'line'
                      },
                      title: {
                          text: 'Project Passing Rate along with Running time'
                      },
                      subtitle: {
                          text: null
                      },
                      xAxis: {
                          type :'datetime',
                          dateTimeLabelFormats: { // don't display the dummy year
                              month: '%e. %b. %y',
                              year: '%b'
                          },
                          title: {
                              text: 'Running Time'
                          },
                      },
                      yAxis: {
                          title: {
                              text: 'Passing Rate (%)'
                          }
                      },
                      credits: {
                          enabled:false
                      },
                      exporting:{
                        enabled:false
                      },
                      tooltip: {
                            headerFormat: '<b>'+'Proj: '+'{series.name}'+'</b><br>',
                            pointFormat: 'Rt: '+'{point.x:%e. %B. %Y}'+'<br>'+'Pr: '+'{point.y:.1f} %'
                      },

                      plotOptions: {
                          line: {
                              dataLabels: {
                                  enabled: true
                              },
                              enableMouseTracking: true
                          }
                      },
                      series: fig_list
                  });

                }); 
              $(".psearch").click(function(){
                  $('#line_ct').css("display","none");
                  $('#pcontainer').css("display","block");
                  var dic_proj = new Object();
                  var proj_dic = new Object();
                  for (var key1 in rt_dic) {
                     for (var key2 in ps_dic) {
                        if (key1 == key2) {
                           if (rt_dic[key1].runt in dic_proj) {
                              dic_proj[rt_dic[key1].runt].push([ps_dic[key2].pn,ps_dic[key2].tn,rt_dic[key1].model]);
                           }
                           else {
                              dic_proj[rt_dic[key1].runt] = [[ps_dic[key2].pn,ps_dic[key2].tn,rt_dic[key1].model]];
                           }
                        }
                      }
                  }
                  
                  for (var key in dic_proj) {
                    for (var key1 in dic_proj[key]) {
                      if (dic_proj[key][key1][2] in proj_dic) { 
                        proj_dic[dic_proj[key][key1][2]].push([dic_proj[key][key1][0], dic_proj[key][key1][1]]);
                      }
                      else {
                        proj_dic[dic_proj[key][key1][2]] = [[dic_proj[key][key1][0], dic_proj[key][key1][1]]];
                      }
                    }
                  }
                  for (var key in proj_dic) {
                    var pn = 0;
                    var tn = 0;
                    for(var i=0; i < proj_dic[key].length; i++) {
                      for (var j=0; j< proj_dic[key][i].length; j++) {
                          if (j == 0) {
                            pn += proj_dic[key][i][j];
                          }
                          else if (j == 1) {
                            tn += proj_dic[key][i][j]; 
                          }
                      }
                    }
                    proj_dic[key] = [pn, tn];
                  }

                  var sum_tn = 0;
                  var sum_pn = 0;
                  for (var key in proj_dic) {
                       sum_pn +=proj_dic[key][0];
                       sum_tn +=proj_dic[key][1];
                  }
                  //pn and tn 
                  for (var key in proj_dic) {
                       proj_dic[key][0] =parseFloat((proj_dic[key][0]/sum_pn).toFixed(4)) * 100;
                       proj_dic[key][1] =parseFloat((proj_dic[key][1]/sum_tn).toFixed(4)) * 100;
                  }
                  var pn_data = [];
                  var tn_data = [];
                  for (var key in proj_dic) {
                    pn_data.push({name: key, y:proj_dic[key][0]});
                    tn_data.push({name: key, y:proj_dic[key][1]});                    
                  }
                  Highcharts.chart('lpcontainer', {
                      chart: {
                          type: 'pie'
                      },
                      title: {
                          text: 'The proportion of project cases of all cases '
                      },
                      subtitle: {
                          text: null
                      },
                      credits: {
                          enabled:false
                      },
                      exporting:{
                        enabled:false
                      },
                      plotOptions: {
                          series: {
                              dataLabels: {
                                  enabled: true,
                                  format: '{point.name}: {point.y:.2f}%'
                              }
                          }
                      },

                      tooltip: {
                          headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
                          pointFormat: '<span style="color:{point.color}">{point.name}</span>: <b>{point.y:.2f}%</b> of total<br/>'
                      },
                      series: [{
                        name: 'All Project Cases',
                        colorByPoint: true,
                        data: pn_data
                    }]
                  });
                  Highcharts.chart('rpcontainer', {
                      chart: {
                          type: 'pie'
                      },
                      title: {
                          text: 'The proportion of project passing cases of all passing cases '
                      },
                      subtitle: {
                          text: null
                      },
                      credits: {
                          enabled:false
                      },
                      exporting:{
                        enabled:false
                      },
                      plotOptions: {
                          series: {
                              dataLabels: {
                                  enabled: true,
                                  format: '{point.name}: {point.y:.2f}%'
                              }
                          }
                      },

                      tooltip: {
                          headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
                          pointFormat: '<span style="color:{point.color}">{point.name}</span>: <b>{point.y:.2f}%</b> of total<br/>'
                      },
                      series: [{
                        name: 'All Module passing Cases',
                        colorByPoint: true,
                        data: tn_data
                    }]
                  });

                }); 
              $(".close").click(function(){
                $('#line_ct').hide();
                $('#pcontainer').hide();
              });
        }
        else {
          if (module == "") {
            $('#show_all').empty();
            $('#show_all').append('<div><input class="csearch" type="button"  value="show Line" /><input  class="psearch" type="button"  value="show Pie" /><input  class="close" type="button"  value="Close" /></div><div id="show_tab1" style="margin-top:20px;"><table id="tab1" class="display"><thead><tr><th>Module</th><th>Module Design Owner</th><th>Module Verif Owner</th><th>Passing Rate</th><th>Run time</th></tr></thead><tfoot><tr><th></th><th></th><th></th><th></th><th></th></tr></tfoot><tbody></tbody></table></div><div id ="line_ct" style="display:none;margin:16px 0px;"><div id="ccontainer" style="min-width: 310px; height: 400px; margin: 0 auto;"></div></div><div id= "pcontainer" style="display: none;margin:16px 40px; height:410px;"><div id="left_ct" style="width:600px;float:left;" ><div id="lpcontainer" style="min-width: 310px; max-width: 600px; height: 400px; margin:0px;"></div></div><div id="right_ct" style="width:600px;float:left;"><div id="rpcontainer" style="min-width: 310px; max-width: 600px; height: 400px; margin:0px;"></div></div></div><div id="show_tab2" style="margin-top:20px;"><table id="tab2" class="display"><thead><tr><th>Module</th><th>Module Design Owner</th><th>Module Verif Owner</th><th>Passing Rate</th><th>Run time</th></tr></thead><tfoot><tr><th></th><th></th><th></th><th></th><th></th></tr></tfoot><tbody></tbody></table></div>');
            $('#tab1').DataTable( {      
              "deferRender": true,
              "destroy": true,
              "lengthChange": false,
              "lengthMenu": [
                [5, 6, 8, -1],
                [5, 10, 15, "All"]
               ],//每页显示条数设置
              "bPaginate": true, //翻页功能
              "searching": true,
              "order":[[4,'desc']],
              "scrollY": "170px",//dt高度
              "ajax": {
                  url:"{% url 'regr:get_model' %}",
                  data: {'model':'module','user':user, 'proj':proj, 'module':'None', 'tstart':tstart, 'tend':tend, 'tflag':'day'} 
              },   
              "columns": [
              { "data": "day.model_list.0" },
              { "data": "day.model_list.1" },
              { "data": "day.model_list.2" },
              { "data": "day.items",
                "render": function (data, type, full, meta) {
                    return data.pr + '%'+ "("+ data.pn + '/'+ data.tn +")";
                 },
                "createdCell": function (tr, cellData, rowData, row, col) {
                    $(tr).css('background', cellData.bc);
                 }
              },
              { "data": "day.time",
                "render": function (data, type, full, meta) {            
                    return data.runt;
                 }
              }
              ],
              initComplete: function () {//列筛选
                   var api = this.api();
                   window.rt_dic = {};
                   window.ps_dic = {};
                   api.columns().indexes().flatten().each(function (i) {
                      if (i == 3) {
                           var column = api.column(i);
                           column.data().sort().each(function (d, j) {
                              ps_dic[j] = d;
                           });
                       } 
                       else if(i == 4) {
                           var column = api.column(i);
                           column.data().sort().each(function (d, j) {
                              rt_dic[j] = d;
                           });
                       }   
                   });
                  api.columns().indexes().flatten().each(function (i) {
                     if (i !=3 && i !=4) {
                         var column = api.column(i);
                         var $span = $('<span class="addselect" style="font-size:11px;">▾</span>').appendTo($(column.header()))
                         var select = $('<select><option value="">All</option></select>')
                                 .appendTo($(column.header()))
                                 .on('click', function (evt) {
                                     evt.stopPropagation();
                                     var val = $.fn.dataTable.util.escapeRegex(
                                             $(this).val()
                                     );
                                     column.search(val ? '^' + val + '$' : '', true, false).draw();                   
                                 });
                         column.data().unique().sort().each(function (d, j) {
                             function delHtmlTag(str) {
                                 return str.replace(/<[^>]+>/g, "");//去掉html标签
                             }

                             d = delHtmlTag(d)
                             select.append('<option value="' + d + '">' + d + '</option>')
                             $span.append(select)
                         });
                     }
                 });
               },
            });
            $('#tab2').DataTable( {      
              "deferRender": true,
              "destroy": true,
              "lengthChange": false,
              "bPaginate": true, //翻页功能
              "searching": true,
              "order":[[4,"desc"]],
              "scrollY": "350px",//dt高度
              "ajax": {
                url:"{% url 'regr:get_model'%}",
                data: {'model':'module','user':user, 'proj':proj, 'module':'None', 'tstart':tstart, 'tend':tend, 'tflag':'sec'} 
              },   
              "columns": [
              { "data": "sec.model_list.0" },
              { "data": "sec.model_list.1" },
              { "data": "sec.model_list.2" },
              { "data": "sec.items",
              "render": function (data, type, full, meta) {
                   return data.pr + '%'+ "("+ data.pn + '/'+ data.tn +")";
                  },
              "createdCell": function (tr, cellData, rowData, row, col) {
                    $(tr).css('background', cellData.bc);
                  }
              },
              { "data": "sec.time",
              "render": function (data, type, full, meta) {            
                return data.runt;
                  }
              }
              ],
              initComplete: function () {//列筛选
                var api = this.api();
                api.columns().indexes().flatten().each(function (i) {
                   if (i !=3 && i !=4) {
                       var column = api.column(i);
                       var $span = $('<span class="addselect" style="font-size:11px;">▾</span>').appendTo($(column.header()))
                       var select = $('<select><option value="">All</option></select>')
                               .appendTo($(column.header()))
                               .on('click', function (evt) {
                                   evt.stopPropagation();
                                   var val = $.fn.dataTable.util.escapeRegex(
                                           $(this).val()
                                   );
                                   column.search(val ? '^' + val + '$' : '', true, false).draw();
                               });
                       column.data().unique().sort().each(function (d, j) {
                           function delHtmlTag(str) {
                               return str.replace(/<[^>]+>/g, "");//去掉html标签
                           }

                           d = delHtmlTag(d)
                           select.append('<option value="' + d + '">' + d + '</option>')
                           $span.append(select)
                       });
                   }
               });
              },
            });
            $(".csearch").click(function(){
                $('#pcontainer').css("display","none");
                $('#line_ct').css("display","block");
                var dic_rt   = new Object();
                var dic_proj = new Object();
                var passrt   = new Array();
                var fig_list = new Array();
                function sortDict(dict) {
                  var dict2 = {}, keys = Object.keys(dict).sort();
                  for (var i=0, key, n=keys.length; i < n; ++i) {
                      key=keys[i];
                      dict2[key] = dict[key];
                  }
                  return dict2;
                }
                for (var key1 in rt_dic) {
                   for (var key2 in ps_dic) {
                      if (key1 == key2) {
                         if (rt_dic[key1].runt in dic_rt) {
                            dic_rt[rt_dic[key1].runt].push([ps_dic[key2].pr,rt_dic[key1].model]);
                         }
                         else {
                            dic_rt[rt_dic[key1].runt] = [[ps_dic[key2].pr,rt_dic[key1].model]];                          
                         }
                      }
                    }
                }
                var rtDic = sortDict(dic_rt);
                for (var key in rtDic ) {
                    var regEx = new RegExp("\\_", "gi");
                    var keys = key.replace(regEx,"/");
                    var sec  = Date.parse(keys)+24*60*60*1000;
                    for (var key1 in rtDic[key]) {
                      if(rtDic[key][key1][1] in dic_proj){
                        dic_proj[rtDic[key][key1][1]].push([sec,rtDic[key][key1][0]]);   
                      }
                      else {
                        dic_proj[rtDic[key][key1][1]]=[[sec,rtDic[key][key1][0]]];
                      }
                    }
                }
                for (var key in dic_proj) {
                    fig_list.push({'name':key, 'data': dic_proj[key]})
                }

                Highcharts.chart('ccontainer', {
                    chart: {
                        type: 'line'
                    },
                    title: {
                        text: 'Project Passing Rate along with Running time'
                    },
                    subtitle: {
                        text: null
                    },
                    credits: {
                        enabled:false
                    },
                    exporting:{
                      enabled:false
                    },
                    xAxis: {
                        type :'datetime',
                        dateTimeLabelFormats: { // don't display the dummy year
                            month: '%e. %b. %y',
                            year: '%b'
                        },
                        title: {
                            text: 'Running Time'
                        },
                    },
                    yAxis: {
                        title: {
                            text: 'Passing Rate (%)'
                        }
                    },
                    tooltip: {
                          headerFormat: '<b>'+'Proj: '+'{series.name}'+'</b><br>',
                          pointFormat: 'Rt: '+'{point.x:%e. %B. %Y}'+'<br>'+'Pr: '+'{point.y:.1f} %'
                    },

                    plotOptions: {
                        line: {
                            dataLabels: {
                                enabled: true
                            },
                            enableMouseTracking: true
                        }
                    },
                    series: fig_list
                });

              }); 
            $(".psearch").click(function(){
                $('#line_ct').css("display","none");
                $('#pcontainer').css("display","block");
                var dic_model = new Object();
                var model_dic = new Object();
                for (var key1 in rt_dic) {
                   for (var key2 in ps_dic) {
                      if (key1 == key2) {
                         if (rt_dic[key1].runt in dic_model) {
                            dic_model[rt_dic[key1].runt].push([ps_dic[key2].pn,ps_dic[key2].tn,rt_dic[key1].model]);
                         }
                         else {
                            dic_model[rt_dic[key1].runt] = [[ps_dic[key2].pn,ps_dic[key2].tn,rt_dic[key1].model]];
                         }
                      }
                    }
                }
                for (var key in dic_model) {
                  for (var key1 in dic_model[key]) {
                    if (dic_model[key][key1][2] in model_dic) { 
                      model_dic[dic_model[key][key1][2]].push([dic_model[key][key1][0], dic_model[key][key1][1]]);
                    }
                    else {
                      model_dic[dic_model[key][key1][2]] = [[dic_model[key][key1][0], dic_model[key][key1][1]]];
                    }
                  }
                }
                for (var key in model_dic) {
                  var pn = 0;
                  var tn = 0;
                  for(var i=0; i < model_dic[key].length; i++) {
                    for (var j=0; j< model_dic[key][i].length; j++) {
                        if (j == 0) {
                          pn += model_dic[key][i][j];
                        }
                        else if (j == 1) {
                          tn += model_dic[key][i][j]; 
                        }
                    }
                  }
                  model_dic[key] = [pn, tn];
                }
                var sum_tn = 0;
                var sum_pn = 0;
                for (var key in model_dic) {
                     sum_pn +=model_dic[key][0];
                     sum_tn +=model_dic[key][1];
                }
                //pn and tn 
                for (var key in model_dic) {
                     model_dic[key][0] =parseFloat((model_dic[key][0]/sum_pn).toFixed(4)) * 100;
                     model_dic[key][1] =parseFloat((model_dic[key][1]/sum_tn).toFixed(4)) * 100;
                }
                var pn_data = [];
                var tn_data = [];
                for (var key in model_dic) {
                  pn_data.push({name: key, y:model_dic[key][0]});
                  tn_data.push({name: key, y:model_dic[key][1]});                    
                }
                Highcharts.chart('lpcontainer', {
                    chart: {
                        type: 'pie'
                    },
                    title: {
                        text: 'The proportion of module cases of all cases'
                    },
                    subtitle: {
                        text: null
                    },
                    credits: {
                        enabled:false
                    },
                    exporting:{
                      enabled:false
                    },
                    plotOptions: {
                        series: {
                            dataLabels: {
                                enabled: true,
                                format: '{point.name}: {point.y:.2f}%'
                            }
                        }
                    },

                    tooltip: {
                        headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
                        pointFormat: '<span style="color:{point.color}">{point.name}</span>: <b>{point.y:.2f}%</b> of total<br/>'
                    },
                    series: [{
                      name: 'All Module Cases',
                      colorByPoint: true,
                      data: tn_data
                  }]
                });
                Highcharts.chart('rpcontainer', {
                    chart: {
                        type: 'pie'
                    },
                    title: {
                        text: 'The proportion of module passing cases of all passing cases'
                    },
                    subtitle: {
                        text: null
                    },
                    credits: {
                        enabled:false
                    },
                    exporting:{
                      enabled:false
                    },
                    plotOptions: {
                        series: {
                            dataLabels: {
                                enabled: true,
                                format: '{point.name}: {point.y:.2f}%'
                            }
                        }
                    },

                    tooltip: {
                        headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
                        pointFormat: '<span style="color:{point.color}">{point.name}</span>: <b>{point.y:.2f}%</b> of total<br/>'
                    },
                    series: [{
                      name: 'All Module passing Cases',
                      colorByPoint: true,
                      data: pn_data
                  }]
                });

              }); 
            $(".close").click(function(){
              $('#line_ct').hide();
              $('#pcontainer').hide();
            });
          }
          else {
            $('#show_all').empty();
            $('#show_all').append('<div id="show_tab2" style="margin-top:20px;"><table id="tab2" class="display"><thead><tr><th>Case Name</th><th>Case Simv</th><th>SVN CL</th><th>Seed</th><th>Status</th><th>Error Stage</th><th>Error Info</th><th>CPU Time</th><th>Run Time</th></tr></thead><tfoot><tr><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr></tfoot><tbody></tbody></table></div>');
             $('#tab2').DataTable( {      
              "deferRender": true,
              "destroy": true,
              "lengthMenu": [
                  [15, 6, 8, -1],
                  [15, 6, 8, "All"]
               ],//每页显示条数设置
              "lengthChange": false,
              "bPaginate": true, //翻页功能
              "searching": true,
              "order":[[8,"desc"]],
              "scrollY": "545px",//dt高度
              "ajax": {
                  url:"{% url 'regr:get_model'  %}",
                  data: {'model':'case','user':user, 'proj':proj, 'module':module, 'tstart':tstart, 'tend':tend} 
              },   
              "columns": [
                  { "data": "sec.case.casename" },
                  { "data": "sec.case.vn" },
                  { "data": "sec.case.proj_cl" },
                  { "data": "sec.case.seed" },
                  { "data": "sec.case",
                      "render": function (data, type, full, meta) {
                          return data.status
                      },
                      "createdCell": function (tr, cellData, rowData, row, col) {
                          $(tr).css('background', cellData.bc);
                      },  
                  },
                  { "data": "sec.case.error_stage" },
                  { "data": "sec.case.error_info" },
                  { "data": "sec.case.simu_cpu_time" },
                  { "data": "sec.time",
                      "render": function (data, type, full, meta) {            
                          return  data.runt ;
                      }
                  }
                ],
              });
            }
          }
        }
      }  
    });
});
</script>
{% endblock %}
