### generated by Jinja2 template, used by prun
{%-for ced_key, ced_value in CED|dictsort%}
{{ced_key}} = {{ced_value}}
{%-endfor%}

### internal variables
dir_guard = @mkdir -p ${@D}
cd_guard = @cd ${@D}

### targets
.PHONY: list_all
list_all:
	@echo '******************************'
	@echo all cases of module ${PROJ_MODULE}
	@echo '******************************'
{%-for case, seed_lst in cgs_dic|dictsort%}
	@echo {{case}}
{%-endfor%}
	@echo '******************************'

.PHONY: compile_all
compile_all: \
{%-for group in group_dic_lst%}
{%-if loop.last%}
${GROUP_DIR}/{{group.name}}/simv
{%-else%}
${GROUP_DIR}/{{group.name}}/simv \
{%-endif%}
{%-endfor%}

.PHONY: analysis_dut_all
analysis_dut_all: \
{%-for group in group_dic_lst%}
{%-if loop.last%}
${GROUP_DIR}/{{group.name}}/.dut_ana
{%-else%}
${GROUP_DIR}/{{group.name}}/.dut_ana \
{%-endif%}
{%-endfor%}

.PHONY: analysis_tb_all
analysis_tb_all: \
{%-for group in group_dic_lst%}
{%-if loop.last%}
${GROUP_DIR}/{{group.name}}/.tb_ana
{%-else%}
${GROUP_DIR}/{{group.name}}/.tb_ana \
{%-endif%}
{%-endfor%}

{%for case, gs_lst in cgs_dic|dictsort%}
.PHONY: run_simv_{{case}}
run_simv_{{case}}: \
{%-for seed in gs_lst[1:]%}
{%-if loop.last%}
run_simv_{{case}}__{{seed}}
{%-else%}
run_simv_{{case}}__{{seed}} \
{%-endif%}
{%-endfor%}

.PHONY: verdi_{{case}}
verdi_{{case}}: \
{%-for seed in gs_lst[1:]%}
{%-if loop.first%}
verdi_{{case}}__{{seed}}
{%-endif%}
{%-endfor%}
{%endfor%}

### c compilation
{%-if c_lst%}
{%-for c in c_lst%}
${CLIB_DIR}/{{c}}.o: ${MODULE_C}/{{c}}.c
	${dir_guard}
	${cd_guard} && gcc {{c_opts}} -I${VCS_HOME}/include -c $<
{%-endfor%}
${CLIB_DIR}/uvm_dpi.o: ${UVM_HOME}/src/dpi/uvm_dpi.cc
	${dir_guard}
	${cd_guard} && g++ {{c_opts}} -I${VCS_HOME}/include -c $<
${CLIB_DIR}/lib${MODULE}.so: \
{%-for c in c_lst%}
${CLIB_DIR}/{{c}}.o \
{%-endfor%}
${CLIB_DIR}/uvm_dpi.o
	${dir_guard}
	${cd_guard} && gcc -shared -o $@ $^
compile_c: ${CLIB_DIR}/lib${MODULE}.so
{%-endif%}

### group targets
{%-for group in group_dic_lst%}
${GROUP_DIR}/{{group.name}}/dut.flist: \
{%-for dut_file in group.dut_file_lst%}
{{dut_file}} \
{%-endfor%}
${GROUP_DIR}/{{group.name}}/group_dutfl.pcl
	${dir_guard}
{%-if not group.dut_file_lst%}
	@echo > $@
{%-endif%}
{%-for dut_file in group.dut_file_lst%}
{%-if loop.first%}
	@echo {{dut_file}} > $@
{%-else%}
	@echo {{dut_file}} >> $@
{%-endif%}
{%-endfor%}
{%-for dut_dir in group.dut_dir_lst%}
	@echo {{dut_dir}} >> $@
{%-endfor%}

${GROUP_DIR}/{{group.name}}/tb.flist: \
{%-for tb_file in group.tb_file_lst%}
{{tb_file}} \
{%-endfor%}
{%-for tb_file in group.tb_dep_file_lst%}
{{tb_file}} \
{%-endfor%}
${GROUP_DIR}/{{group.name}}/group_tbfl.pcl
	${dir_guard}
{%-if not group.tb_file_lst%}
	@echo > $@
{%-endif%}
{%-for tb_file in group.tb_file_lst%}
{%-if loop.first%}
	@echo {{tb_file}} > $@
{%-else%}
	@echo {{tb_file}} >> $@
{%-endif%}
{%-endfor%}
{%-for tb_dir in group.tb_dir_lst%}
	@echo {{tb_dir}} >> $@
{%-endfor%}

${GROUP_DIR}/{{group.name}}/.dut_ana: \
${GROUP_DIR}/{{group.name}}/dut.flist \
${GROUP_DIR}/{{group.name}}/group_cfg.json \
${CMN_CONFIG}/proj.cfg
	${cd_guard} && \
	{{group.ana_tool}} \
	{{group.da_opts}} \
{%-if group.ca_opts%}
	{{group.ca_opts}} \
{%-endif%}
	-f $< \
	-l ${GROUP_DIR}/{{group.name}}/dut_ana.log && \
	touch $@

${GROUP_DIR}/{{group.name}}/.tb_ana: \
${GROUP_DIR}/{{group.name}}/tb.flist \
${GROUP_DIR}/{{group.name}}/group_cfg.json \
${CMN_CONFIG}/proj.cfg
	${cd_guard} && \
	{{group.ana_tool}} \
	{{group.ta_opts}} \
{%-if group.ca_opts%}
	{{group.ca_opts}} \
{%-endif%}
	-f $< \
	-l ${GROUP_DIR}/{{group.name}}/tb_ana.log && \
	touch $@

{%for file_name, file_line_lst in group.file_dic|dictsort%}
${GROUP_DIR}/{{group.name}}/{{file_name}}: \
${GROUP_DIR}/{{group.name}}/group_cfg.json \
${CMN_CONFIG}/proj.cfg
	${dir_guard}
{%-for file_line in file_line_lst%}
{%-if loop.first%}
	@echo '{{file_line}}' > $@
{%-else%}
	@echo '{{file_line}}' >> $@
{%-endif%}
{%-endfor%}
{%endfor%}

${GROUP_DIR}/{{group.name}}/simv: \
{%-for file_name, file_cont in group.file_dic|dictsort%}
${GROUP_DIR}/{{group.name}}/{{file_name}} \
{%-endfor%}
{%-if c_lst%}
compile_c \
{%-endif%}
${GROUP_DIR}/{{group.name}}/.dut_ana \
${GROUP_DIR}/{{group.name}}/.tb_ana
	${cd_guard} && \
{%-for pre_cmd in group.pre_cmd_lst%}
	{{pre_cmd}} && \
{%-endfor%}
	{{group.elab_tool}} \
	{{group.e_opts}} \
{%-if group.ce_opts%}
	{{group.ce_opts}} \
{%-endif%}
	-top {{group.tb_top}} \
{%-if c_lst%}
	-LDFLAGS -L${CLIB_DIR} -l${MODULE} \
{%-endif%}
	-l ${GROUP_DIR}/{{group.name}}/elab.log \
	-o $@
{%-for post_cmd in group.post_cmd_lst-%}
	{{' '}}&& \
	{{post_cmd}}
{%-endfor%}

.PHONY: verdi_{{group.name}}
verdi_{{group.name}}: ${GROUP_DIR}/{{group.name}}/.dut_ana
	cd ${GROUP_DIR}/{{group.name}} && \
	verdi {{group.w_opts}} -simflow -lib work -nologo &
{%endfor%}

### case targets
{%-for case in case_dic_lst%}
.PHONY: run_simv_{{case.name}}__{{case.seed}}
run_simv_{{case.name}}__{{case.seed}}: \
${GROUP_DIR}/{{case.group}}/simv \
{%-for file_name, file_cont in case.file_dic|dictsort%}
${MODULE_OUTPUT}/{{case.name}}/{{case.seed}}/{{file_name}} \
{%-endfor%}
${MODULE_OUTPUT}/{{case.name}}/{{case.seed}}/{{case.name}}.tcl
{%-if c_lst%}
	export LD_LIBRARY_PATH=${CLIB_DIR}:${LD_LIBRARY_PATH} && \
{%-endif%}
{%-for pre_cmd in case.pre_cmd_lst%}
	{{pre_cmd}} && \
{%-endfor%}
	mkdir -p ${MODULE_OUTPUT}/{{case.name}}/{{case.seed}} && \
	cd ${MODULE_OUTPUT}/{{case.name}}/{{case.seed}} && \
	$< \
	+TEMPDIR=${MODULE_OUTPUT}/{{case.name}}/{{case.seed}} \
	{{case.su_opts}} \
	-l ${MODULE_OUTPUT}/{{case.name}}/{{case.seed}}/{{case.seed}}.log \
	-ucli -i ${MODULE_OUTPUT}/{{case.name}}/{{case.seed}}/{{case.name}}.tcl
{%-for post_cmd in case.post_cmd_lst-%}
	{{' '}}&& \
	{{post_cmd}}
{%-endfor%}

.PHONY: ${MODULE_OUTPUT}/{{case.name}}/{{case.seed}}/{{case.name}}.tcl
${MODULE_OUTPUT}/{{case.name}}/{{case.seed}}/{{case.name}}.tcl:
	${dir_guard}
	@echo > $@
{%-if case.wave%}
{%-if case.wave_format == 'fsdb'%}
	@echo fsdbDumpfile {{case.name}}__{{case.seed}}.fsdb >> $@
	@echo fsdbDumpvars 0 {{case.tb_top}} >> $@
{%-if case.wave_mem%}
	@echo fsdbDumpMDA
{%-endif%}
{%-if case.wave_glitch%}
	@echo fsdbDumpon +glitch
{%-endif%}
{%-endif%}
{%-endif%}
	@echo run >> $@

{%for file_name, file_line_lst in case.file_dic|dictsort%}
.PHONY: ${MODULE_OUTPUT}/{{case.name}}/{{case.seed}}/{{file_name}}
${MODULE_OUTPUT}/{{case.name}}/{{case.seed}}/{{file_name}}:
	${dir_guard}
{%-for file_line in file_line_lst%}
{%-if loop.first%}
	@echo '{{file_line}}' > $@
{%-else%}
	@echo '{{file_line}}' >> $@
{%-endif%}
{%-endfor%}
{%endfor%}

.PHONY: verdi_{{case.name}}__{{case.seed}}
verdi_{{case.name}}__{{case.seed}}: ${GROUP_DIR}/{{case.group}}/simv
	mkdir -p ${MODULE_OUTPUT}/{{case.name}}/{{case.seed}} && \
	cd ${MODULE_OUTPUT}/{{case.name}}/{{case.seed}} && \
	verdi {{case.w_opts}} -simflow -simBin $< \
	-ssf ${MODULE_OUTPUT}/{{case.name}}/{{case.seed}}/{{case.name}}__{{case.seed}}.fsdb \
	-nologo &
{%endfor%}
